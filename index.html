<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auftragskarte</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
#map { width: 95%; height: 80vh; margin: 10px auto; }
body { font-family: Arial; text-align:center; }
input, button { margin:5px; padding:6px; }
</style>
</head>
<body>
<h1>Offene Aufträge Karte</h1>

<input type="file" id="excelInput" accept=".xlsx,.xls" />
<button id="loadBtn">Aufträge laden</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
const map = L.map('map').setView([51.1657, 10.4515], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);

document.getElementById('loadBtn').addEventListener('click', async () => {
  const file = document.getElementById('excelInput').files[0];
  if(!file) { alert("Bitte zuerst eine Excel-Datei auswählen"); return; }

  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data,{type:'array'});
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet);

  for(const row of rows){
    if(!row.Lieferadresse) continue;

    // Geokodierung via Nominatim
    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(row.Lieferadresse+', Deutschland')}`);
    const geoData = await geoRes.json();
    if(!geoData.length) continue;
    const {lat, lon, display_name} = geoData[0];

    // Markerfarbe nach Priorität
    const icon = L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${row.Priorität || 'green'}.png`,
      shadowUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
    });

    const marker = L.marker([lat,lon],{icon}).addTo(map);

    const popupHTML = `
      <b>Auftragsnummer:</b> ${row.Auftragsnummer}<br>
      <b>Lieferadresse:</b> ${display_name}<br>
      <b>Kundenbeanstandung:</b> ${row.Kundenbeanstandung}<br>
      <b>Grund:</b> ${row.Grund}<br>
      <b>PLZ:</b> ${row.PLZ}<br>
      <b>Eingangsdatum:</b> ${row.Eingangsdatum}<br>
      <b>Priorität:</b> ${row.Priorität}<br>
      <b>Ticketnummer:</b> ${row.Ticketnummer}<br>
      <b>Besteller:</b> ${row.Besteller}<br>
      <b>Telefon:</b> ${row.Telefon}<br>
      <b>Mail:</b> ${row.Mail}
    `;
    marker.bindPopup(popupHTML);
  }
});
</script>
</body>
</html>
